<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Is my connection really secure?</title>
    <meta name="viewport" content="width=device-width">
    <meta content = "Paolo Perego" name = "author" />

    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/stylesheets/syntax.css">

    <link href = "/stylesheets/bootstrap.min.css" rel = "stylesheet" />
    <link href = "/stylesheets/bootstrap-responsive.min.css" rel = "stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/stylesheets/thesp0nge.css">

    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-22125982-1']);
      _gaq.push(['_setDomainName', 'thesp0nge.com']);
      _gaq.push(['_trackPageview']);

      (function() {
       var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
       ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
       var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
       })();

     </script>

  </head>
  <body>

        <!-- NAVBAR
    ================================================== -->
    <div class="navbar-wrapper">
      <!-- Wrap the .navbar in .container to center it within the absolutely positioned parent. -->
      <div class="container">

        <div class="navbar">
          <div class="navbar-inner">
            <a class="brand" href="/">Paolo Perego</a>
            <!-- Responsive Navbar Part 2: Place all navbar contents you want collapsed withing .navbar-collapse.collapse. -->
            <div class="nav-collapse collapse">
              <ul class="nav">
                <li class="active"><a href="/">Home</a></li>
                <li><a href="/blog">Blog</a></li>
                <li><a href="#about">About</a></li>
                <li><a href="#contact">Contact</a></li>
              </ul>
            </div><!--/.nav-collapse -->
          </div><!-- /.navbar-inner -->
        </div><!-- /.navbar -->

      </div> <!-- /.container -->
    </div><!-- /.navbar-wrapper -->

    <div class="container marketing">
      <h2>Is my connection really secure?</h2>
<p class="meta">25 Jan 2012</p>
<div>
<p>This article will take about 5  minutes minutes to read.</p>
</div>

<div class="post">
<p>When you connect to a HTTPS server you must ensure the certificate is correct
before submitting sentitive data.
Modern browser do a lot of work for unexperienced users and if you see a green
lock, hopefully you can consider your communication to be secured.</p>

<p>But what about the penetration tester perspective?</p>

<h2>Some step before</h2>

<p>Days ago, I was attending a workshop showing how to break web applications and
the first step explained was fingerprint and information gathering.
SSLDigger, formerly by Foundstone, now a McAffee tool, was taken as example to
list all available ciphers in a HTTPS connection.</p>

<p>The tool is no longer maintained and it requires and old .NET libraries version
and, most important, it doesn&#39;t run in a unix based environment.</p>

<!-- more -->

<h2>The Google and the Net</h2>

<p>In a second I found some great bash script for enumerating available scripts. 
Algorithm is quite basic:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">  given a protocol do
    for all ciphers openssl knows for that protocol do
      try open a connection and writing &quot;GET / HTTP/1.0&quot;
      if the server complains
        cipher is not supported
      else
        cipher is supported
      end
    end
  end 
</code></pre></div>
<p>That&#39;s it, in a minute I can use a script and venerable openssl tool to make
the same things SSLDigger ask me to download Megs of .NET 1.x libraries data.</p>

<h2>Wait, I&#39;m a ruby fan boy</h2>

<p>Ok, the script works fine but I want something more hackish I can tweak and I
can integrate in scripts or more complex software.</p>

<p>More of this I want more then enumerating ciphers, I want something tell me the
HTTPS connection can be hardened more or the supported protocol vs ciphers
combination is good enough,</p>

<p>Looking at the Net for ispiration I found a this ruby script in a blog (sorry,
I can&#39;t retrieve it so if you&#39;re reading and you&#39;re the ssl_picker.rv daddy,
yes... write me down your blog url in the comments and I&#39;ll check back this
post).</p>

<p>``` ruby ssl_picker.rb 
require &#39;socket&#39;
require &#39;openssl&#39;
require &#39;net/https&#39;</p>

<p>module Net
  class HTTP
    def set<em>context=(value)
      @ssl</em>context = OpenSSL::SSL::SSLContext.new
      @ssl<em>context &amp;&amp;= OpenSSL::SSL::SSLContext.new(value)
    end
    ssl</em>context_accessor :ciphers
  end
end</p>

<p>protocol<em>version = [:SSLv2, :SSLv3, :TLSv1]
protocol</em>version.each do |version|
  puts version
  cipher<em>set = OpenSSL::SSL::SSLContext.new(version).ciphers
  cipher</em>set.each do |cipher<em>name, cipher</em>version, bits, algorithm<em>bits|
    request = Net::HTTP.new(&#39;extranet.sky.it&#39;, 443)
    request.use</em>ssl = true
    request.set<em>context = version
    request.verify</em>mode = OpenSSL::SSL::VERIFY<em>NONE
    request.ciphers = cipher</em>name
    begin
      response = request.get(&quot;/&quot;)
      puts &quot;[+] Accepted\t #{bits} bits\t#{cipher<em>name}&quot;
    rescue OpenSSL::SSL::SSLError =&gt; e
      puts &quot;[-] Rejected\t #{bits} bits\t#{cipher</em>name}&quot;
    rescue #Ignore all other Exceptions
    end
  end
end
```</p>

<p>Ok, this looks interesting but it doesn&#39;t work with ruby 1.9.x anymore since
ssl<em>context</em>accessor was first deprecated and now removed from Net::HTTP.</p>

<p>So I taken the ssl_picker.rb script and I moved it further in a more complex
ruby gem <a href="https://github.com/thesp0nge/ciphersurfer">ciphersurfer</a></p>

<p>Of course, due to ssl<em>context</em>accessor thing, you can&#39;t run the gem using 1.8.
Well true to be told I don&#39;t test executing it with older rubies, I use the
<em>this ruby version is not supported</em> statement.</p>

<p>``` ruby lib/ciphersurfer/net_http.rb
require &#39;socket&#39;
require &#39;net/https&#39;
require &#39;openssl&#39;</p>

<p>module Net
  class HTTP
    def set<em>context=(value)
      @ssl</em>context = OpenSSL::SSL::SSLContext.new
      @ssl_context &amp;&amp;= OpenSSL::SSL::SSLContext.new(value)
    end</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">def ciphers
  return nil unless @ssl_context
  @ssl_context.ciphers
end

def ciphers=(val)
  @ssl_context ||= OpenSSL::SSL::SSLContext.new
  @ssl_context.ciphers = val
end
</code></pre></div>
<p>end
end
```</p>

<p>ssl<em>context</em>accessor in previous Net::HTTP API creates an accessor to a given
ssl_context attributes. I rather guess that API designers removed it since it&#39;s
just an hack and it&#39;s not a clear way to add pieces to the net framework.</p>

<p>I choose to be more polite, and added a getter/setter methods to ping newly
created ssl_context class variable.</p>

<p>The Ciphersurfer.Scanner class has two methods inside. A class method alive?
telling me if there is a server listening to a specific host:port.</p>

<p><code>ruby lib/ciphersurfer/scanner.rb
def self.alive?(host, port)
  request = Net::HTTP.new(host, port)
  request.use_ssl = true
  request.verify_mode = OpenSSL::SSL::VERIFY_NONE 
  begin
    response = request.get(&quot;/&quot;)
    return true
  rescue Errno::ECONNREFUSED =&gt; e
    return false
  rescue OpenSSL::SSL::SSLError =&gt; e
    return false
  end
end
</code> </p>

<p>The other method is the scanner routine that is very close to the original one.
It just returns ciphers ordered in arrays.</p>

<p><code>ruby lib/ciphersurfer/scanner.rb
def go
  cipher_set = OpenSSL::SSL::SSLContext.new(@proto).ciphers
  cipher_set.each do |cipher_name, cipher_version, bits, algorithm_bits|
    request = Net::HTTP.new(@host, @port)
    request.use_ssl = true
    request.set_context = @proto
    request.verify_mode = OpenSSL::SSL::VERIFY_NONE
    request.ciphers = cipher_name
    begin
      response = request.get(&quot;/&quot;)
      @ok_ciphers &lt;&lt; {:bits=&gt;bits, :name=&gt;cipher_name}
    rescue OpenSSL::SSL::SSLError =&gt; e
      @ko_ciphers &lt;&lt; {:bits=&gt;bits, :name=&gt;cipher_name}
    rescue 
      # Quietly discard all other errors... you must perform all error chekcs in the calling program
    end
  end
end
</code> </p>

<p>Gem binary is very simple as well. Just ask to scan for all known ciphers given a protocol.</p>

<p>``` ruby bin/ciphersurfer
protocol<em>version = [:SSLv2, :SSLv3, :TLSv1]
protocol</em>version.each do |version|
  puts version
  s = Ciphersurfer::Scanner.new({:host=&gt;ARGV[0], :port=&gt;ARGV[1], :proto=&gt;version})</p>

<p>s.go
  ok = s.ok<em>ciphers
  ko = s.ko</em>ciphers</p>

<p>ok.each do |o|
    puts &quot;[+] Accepted\t #{o[:bits]} bits\t#{o[:name]}&quot;
  end
end
``` </p>

<p>That&#39;s all folks. So if you want to use the gem you must before install it the common way.</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">gem install ciphersurfer
</code></pre></div>
<p>Then you have a ciphersurfer script you can use it this way:</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">ciphersurfer gmail.com 443
</code></pre></div>
<p>Since it&#39;s a 2 hour long hack it lacks a lot of thing:</p>

<ul>
<li>pretty printing</li>
<li>parameter checking</li>
<li>help</li>
<li>database support</li>
<li>a little datamining</li>
</ul>

<p>As I said before I don&#39;t want just to enumerate the ciphers, but I want to give
the user a feedback from the security point of view about the status of the
HTTPS server configuration.</p>

<p>The idea is to implement checks described into <a href="https://www.owasp.org/index.php/Testing_for_SSL-TLS_(OWASP-CM-001)">Owasp Testing
guide</a>,
giving the user (hopefully a security analist) a brief evaluation in terms of
<em>ok, communication is secured here</em> or <em>no, ssl configuration must be locked
down further</em>.</p>

<p>Something even more I want to ad is a basic ORM support to save data in a SQL
form, <a href="http://datamapper.org">datamapper</a> I guess.</p>

</div>



      <div class="row"> <hr /> </div>
      <footer>
      <p class="pull-right"><a href="#">Back to top</a></p>
      <p>&copy; 2013 thesp0nge.com &middot; v4.0.0.rc1 &middot; <a href="#">Privacy</a> &middot; <a href="#">Terms</a></p>
      </footer>

    </div>

    <!-- /container -->
    <script src='/javascripts/jquery.js'></script>
    <script src='/javascripts/bootstrap.min.js'></script>
    <script src='/javascripts/holder.js'></script>
  </body>
</html>
